<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">

<head>
    <div th:replace="fragments/libs :: libs"></div>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<div th:replace="fragments/header :: header">...</div>

<p id="dPS"></p>
<form th:action="@{/logout}" method="post">
    <input type="submit" value="Sign Out"/>
</form>

<script>
    function renderItems() {
        $.getJSON('http://localhost:8080/get_today_items', function (data) {
            let template = $("#items").html();
            let compiledTemplate = Handlebars.compile(template);
            let text = compiledTemplate({"items": data});
            $("#dPS").html(text);
            $(".icon").click(function (event) {
                if($(event.currentTarget).data("checked")) {
                    tickItem($(event.target).data("habit_id"), $(event.target).data("sort"), false);
                } else {tickItem($(event.target).data("habit_id"), $(event.target).data("sort"), true);}
            renderItems();
            });
        });
    }

    function tickItem(habit_id, sort, ticked) {
        let url = "/tick";
        let token = $("meta[name='_csrf']").attr("content");
        $.post(url, {_csrf: token, "habit_id": habit_id, "sort": sort, "ticked": ticked});
    }

    $(function () {
        renderItems();
    });

</script>

<script id="items" type="text/template">
    <dl>
        {{#each items}}
        <dt>
            {{#each this}}
                {{#if checked}}
                    <div class="icon" style="background-image: url('/static/icons/{{icon}}_e.svg')"
                         data-habit_id="{{habit_id}}" data-sort="{{sort}}" data-checked="{{checked}}"></div>
                {{else}}
                    <div class="icon" style="background-image: url('/static/icons/{{icon}}.svg')"
                         data-habit_id="{{habit_id}}" data-sort="{{sort}}" data-checked="{{checked}}"></div>
                {{/if}}
            {{/each}}
        </dt>
        {{/each}}
    </dl>

</script>

</body>
</html>